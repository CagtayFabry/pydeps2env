on: [push, pull_request, workflow_dispatch]

jobs:
  demo_job:
    name: create test env
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        config_file: [./test/setup.cfg, ./test/pyproject.toml]
    steps:
    - uses: actions/checkout@v3
    - name: run local action code
      uses: ./
      with:
        file: ${{ matrix.config_file }}
        output: environment_test.yml
        channels: conda-forge defaults
        extras: test pip_only
        setup_requires: include
        pip: bidict
    - uses: mamba-org/setup-micromamba@v1.8.0
      with:
        environment-file: ./environment_test.yml
        environment-name: demo
        init-shell: >-
          bash
          powershell
        cache-environment: true

  test_script:
    name: create test env
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config_file: [./test/setup.cfg, ./test/pyproject.toml]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: pip install package
      run: pip install .
    - name: test cmd script
      run: pydeps2env ${{ matrix.config_file }} output.yaml -c defaults --extras test -b include --pip pandas
